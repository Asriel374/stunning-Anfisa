import RPi.GPIO as GPIO
import time
import matplotlib.pyplot as plt

# Пины для подключения компонентов
LED_PINS = [5, 6, 13, 19, 26, 12, 16, 20]  # Пины для светодиодов
DAC_PINS = [21, 20, 16, 12, 7, 8, 25, 24]  # Пины для ЦАП
COMP_PIN = 4  # Пин для компаратора
TROYKA_PIN = 17  # Пин для управления тройка-модулем

# Настройка GPIO
GPIO.setmode(GPIO.BCM)
GPIO.setup(LED_PINS, GPIO.OUT)
GPIO.setup(DAC_PINS, GPIO.OUT)
GPIO.setup(COMP_PIN, GPIO.IN)
GPIO.setup(TROYKA_PIN, GPIO.OUT)

# Функция для перевода числа в двоичный формат для отображения на светодиодах
def dec2bin(value):
    return [int(bit) for bit in bin(value)[2:].zfill(8)]

# Функция для измерения напряжения через компаратор
def measure_voltage():
    for value in range(256):
        GPIO.output(DAC_PINS, dec2bin(value))
        time.sleep(0.001)  # Небольшая задержка для стабилизации
        if GPIO.input(COMP_PIN) == 0:
            return value
    return 255  # Максимальное значение, если компаратор не сработал

# Функция для отображения напряжения на светодиодах
def display_on_leds(value):
    GPIO.output(LED_PINS, dec2bin(value))

try:
    # Создаем список для хранения результатов измерений
    measurements = []

    # Сохраняем момент начала эксперимента
    start_time = time.time()

    # Зарядка конденсатора
    GPIO.output(TROYKA_PIN, GPIO.HIGH)  # Подать 3.3В на тройка-модуль
    print("Зарядка конденсатора...")

    # Измерение напряжения во время зарядки
    while True:
        voltage = measure_voltage()
        measurements.append(voltage)
        display_on_leds(voltage)

        # Прекращаем зарядку, если напряжение достигло 97% (примерно 248 из 255)
        if voltage >= 248:
            break

    # Разрядка конденсатора
    GPIO.output(TROYKA_PIN, GPIO.LOW)  # Подать 0В на тройка-модуль
    print("Разрядка конденсатора...")

    # Измерение напряжения во время разрядки
    while True:
        voltage = measure_voltage()
        measurements.append(voltage)
        display_on_leds(voltage)

        # Прекращаем разрядку, если напряжение достигло 2% (примерно 5 из 255)
        if voltage <= 5:
            break

    # Сохраняем момент завершения эксперимента
    end_time = time.time()

    # Рассчитываем продолжительность эксперимента
    duration = end_time - start_time
    print(f"Продолжительность эксперимента: {duration:.2f} секунд")

    # Построение графика
    plt.plot(measurements)
    plt.title("Зависимость напряжения на выходе RC-цепи от номера измерения")
    plt.xlabel("Номер измерения")
    plt.ylabel("Напряжение (единицы АЦП)")
    plt.show()

    # Сохранение данных в файл data.txt
    with open("data.txt", "w") as data_file:
        for measurement in measurements:
            data_file.write(f"{measurement}\n")

    # Средняя частота дискретизации
    avg_frequency = len(measurements) / duration
    quantization_step = 3.3 / 256  # Шаг квантования АЦП

    # Сохранение настроек в файл settings.txt
    with open("settings.txt", "w") as settings_file:
        settings_file.write(f"Средняя частота дискретизации: {avg_frequency:.2f} Гц\n")
        settings_file.write(f"Шаг квантования АЦП: {quantization_step:.5f} В\n")

    # Вывод данных в терминал
    print(f"Период одного измерения: {duration / len(measurements):.5f} секунд")
    print(f"Средняя частота дискретизации: {avg_frequency:.2f} Гц")
    print(f"Шаг квантования АЦП: {quantization_step:.5f} В")

finally:
    # Подать 0 на все GPIO выходы и сбросить настройки GPIO
    GPIO.output(LED_PINS, 0)
    GPIO.cleanup()